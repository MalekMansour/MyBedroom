<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Link Manager</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ================
       Additional Styles
       ================ */

    /* Delete icon next to folder names */
    .folder-delete-icon {
      font-size: 14px;
      color: #777;
      cursor: pointer;
      margin-left: 6px;
      user-select: none;
      transition: color 0.2s;
    }
    .folder-delete-icon:hover {
      color: red;
    }

    /* â€œManage Passwordsâ€ button styling */
    #managePasswordsBtn {
      margin-top: 15px;
      padding: 8px 12px;
      background-color: #333;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #managePasswordsBtn:hover {
      background-color: #444;
    }

    /* Modal: Manage Passwords */
    #manageModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1700;
    }
    #manageModalContent {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #444;
      width: 90%;
      max-width: 400px;
      color: #f0f0f0;
    }
    #manageModalContent h2 {
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    #manageModalContent label {
      display: block;
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    #manageModalContent input {
      width: 100%;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 5px;
      color: #fff;
      padding: 8px;
      margin-bottom: 10px;
      transition: border 0.2s;
    }
    #manageModalContent input:focus {
      border-color: #555;
      outline: none;
    }
    #manageModalContent .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }
    #manageModalContent .modal-buttons button {
      flex: 1;
      margin: 0 6px;
      padding: 8px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      background-color: #333;
      color: #fff;
      transition: background 0.2s;
    }
    #manageModalContent .modal-buttons button:hover {
      background-color: #444;
    }
    #manageModalContent .danger:hover {
      background-color: red;
    }
    #manageModalContent .sectionDivider {
      height: 1px;
      background-color: #444;
      margin: 15px 0;
    }
    #manageModalContent .delete-secondary-btn {
      background-color: #555;
      margin-top: 8px;
    }
    #manageModalContent .delete-secondary-btn:hover {
      background-color: #666;
    }
  </style>
</head>
<body>

  <!-- =====================
       SIDEBAR (folders)
       ===================== -->
  <div class="sidebar">
    <h2>Folders</h2>
    <ul id="folderList"></ul>
    <button id="addFolderBtn">+ Add Folder</button>
  </div>

  <!-- =====================
       MAIN CONTENT AREA
       ===================== -->
  <div class="main">
    <h1 id="folderTitle">Loading...</h1>

    <!-- â€œManage Passwordsâ€ (only shown when inside Hidden folder) -->
    <button id="managePasswordsBtn" class="hidden">Manage Passwords</button>

    <!-- Form to add a new link (hidden when in Hidden folder until unlocked) -->
    <div id="linkFormContainer">
      <form id="linkForm">
        <input type="text" id="linkName" placeholder="Website Name" required>
        <input type="url" id="linkURL" placeholder="https://example.com" required>
        <textarea id="linkDesc" placeholder="Description" rows="2"></textarea>
        <button type="submit">Save Link</button>
      </form>
    </div>

    <!-- Filter by color -->
    <div id="filterContainer">
      <label for="colorFilter">Filter by Color:</label>
      <select id="colorFilter">
        <option value="">All</option>
      </select>
    </div>

    <!-- List of links -->
    <div id="linkList"></div>
  </div>

  <!-- ======================
       CONTEXT MENU (hidden by default)
       ====================== -->
  <div id="contextMenu" class="context-menu">
    <ul>
      <li id="ctxMove">Move to Folderâ€¦</li>
      <li id="ctxColor">Set Color Tagâ€¦</li>
      <li id="ctxShare">Share by Email</li>
      <li id="ctxDelete">Delete Link</li>
    </ul>
  </div>

  <!-- =========================
       MODAL: DELETE CONFIRMATION
       ========================= -->
  <div id="deleteModal">
    <div id="deleteModalContent">
      <h2>Are you sure you want to permanently delete this link?</h2>
      <div class="modal-buttons">
        <button onclick="closeDeleteModal()">Cancel</button>
        <button class="danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- ======================
       MODAL: PASSWORD PROMPT
       ====================== -->
  <div id="passwordModal">
    <div id="passwordModalContent">
      <h2 id="pwdModalTitle">Enter Password</h2>
      <input type="password" id="pwdInput" placeholder="Password">
      <p id="pwdError" style="color: red; margin-top: 6px;"></p>
      <div class="modal-buttons">
        <button onclick="cancelPassword()">Cancel</button>
        <button onclick="submitPassword()">OK</button>
      </div>
    </div>
  </div>

  <!-- =====================
       MODAL: MOVE LINK
       ===================== -->
  <div id="moveModal">
    <div id="moveModalContent">
      <h2>Select a Destination Folder</h2>
      <ul id="folderOptions"></ul>
      <div class="modal-buttons" style="margin-top: 15px;">
        <button onclick="closeMoveModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- =====================
       MODAL: COLOR PICKER
       ===================== -->
  <div id="colorModal">
    <div id="colorModalContent">
      <h2>Choose a Color Tag</h2>
      <div class="color-grid" id="colorGrid"></div>
      <div class="modal-buttons" style="margin-top: 15px;">
        <button onclick="closeColorModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- =============================
       MODAL: MANAGE PASSWORDS
       ============================= -->
  <div id="manageModal">
    <div id="manageModalContent">
      <h2>Manage Hidden Folder Passwords</h2>

      <!-- Change Primary Password -->
      <label for="currentPrimary">Current Primary Password</label>
      <input type="password" id="currentPrimary" placeholder="Current password">
      <label for="newPrimary">New Primary Password</label>
      <input type="password" id="newPrimary" placeholder="New password (min 3 chars)">
      <div class="modal-buttons">
        <button onclick="cancelManage()">Cancel</button>
        <button class="danger" onclick="handleChangePrimary()">Change Primary</button>
      </div>

      <div class="sectionDivider"></div>

      <!-- Secondary Password Section -->
      <div id="secondarySection">
        <div id="setSecondaryDiv">
          <label for="newSecondary">Set Secondary Password</label>
          <input type="password" id="newSecondary" placeholder="New secondary password">
          <div class="modal-buttons">
            <button onclick="cancelManage()">Cancel</button>
            <button onclick="handleSetSecondary()">Set Secondary</button>
          </div>
        </div>

        <!-- If secondary exists â†’ "Change or Delete Secondary" -->
        <div id="editSecondaryDiv" class="hidden">
          <label for="currentSecondary">Current Secondary Password</label>
          <input type="password" id="currentSecondary" placeholder="Current secondary">
          <label for="newSecondaryEdit">New Secondary Password</label>
          <input type="password" id="newSecondaryEdit" placeholder="New secondary password">
          <div class="modal-buttons">
            <button class="delete-secondary-btn" onclick="handleDeleteSecondary()">Delete Secondary</button>
            <button onclick="handleChangeSecondary()">Change Secondary</button>
          </div>
        </div>
      </div>

    </div>
  </div>


  <!-- =====================
       JavaScript Logic
       ===================== -->

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // GLOBAL DATA & INITIAL SETUP
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Each folder: { id: string, name: string, isHidden: boolean }
    // Each link:   { id: string, folderId: string, name: string,
    //               url: string, description: string, color: string }
    // localStorage keys: 'folders', 'links', 'hiddenPassword1', 'hiddenPassword2'

    const DEFAULT_FOLDER_NAME = 'General';
    const HIDDEN_FOLDER_NAME  = 'Hidden';

    let folders = [];           // Array of folder objects
    let links   = [];           // Array of link objects
    let currentFolderId = null; // ID of the folder currently open

    // Modalâ€related state
    let pendingDeleteLinkId     = null;
    let pendingMoveLinkId       = null;
    let pendingColorLinkId      = null;
    let pendingMoveTargetFolderId = null;

    // Hiddenâ€folder password state
    let passwordMode = ''; // 'setHiddenPrimary', 'verifyHiddenPrimary', 'verifyHiddenSecondary'

    // 12â€color palette with names
    const COLOR_PALETTE = [
      { name: 'Red Light',       hex: '#D71313' },
      { name: 'Crimson',         hex: '#BE3144' },
      { name: 'Hot Pink',        hex: '#FF55BB' },
      { name: 'Soft Pink',       hex: '#EC7FA9' },
      { name: 'Platinum',        hex: '#7F55B1' },
      { name: 'Lilac',           hex: '#6F69AC' },
      { name: 'Midnight',        hex: '#2D336B' },
      { name: 'Electric',        hex: '#3A59D1' },
      { name: 'Forest',          hex: '#169976' },
      { name: 'Sage',            hex: '#6A9C89' },
      { name: 'Pumpkin',         hex: '#E78B48' },
      { name: 'Mustard',         hex: '#EFB036' }
    ];

    // DOM references
    const folderListEl       = document.getElementById('folderList');
    const addFolderBtn       = document.getElementById('addFolderBtn');
    const folderTitleEl      = document.getElementById('folderTitle');
    const linkFormContainer  = document.getElementById('linkFormContainer');
    const linkForm           = document.getElementById('linkForm');
    const linkListEl         = document.getElementById('linkList');
    const colorFilterEl      = document.getElementById('colorFilter');
    const managePasswordsBtn = document.getElementById('managePasswordsBtn');

    const contextMenu        = document.getElementById('contextMenu');
    const ctxMove            = document.getElementById('ctxMove');
    const ctxShare           = document.getElementById('ctxShare');
    const ctxColor           = document.getElementById('ctxColor');
    const ctxDelete          = document.getElementById('ctxDelete');

    const deleteModal        = document.getElementById('deleteModal');
    const passwordModal      = document.getElementById('passwordModal');
    const pwdInput           = document.getElementById('pwdInput');
    const pwdError           = document.getElementById('pwdError');

    const moveModal          = document.getElementById('moveModal');
    const folderOptionsEl    = document.getElementById('folderOptions');

    const colorModal         = document.getElementById('colorModal');
    const colorGrid          = document.getElementById('colorGrid');

    const manageModal        = document.getElementById('manageModal');
    const currentPrimaryEl   = document.getElementById('currentPrimary');
    const newPrimaryEl       = document.getElementById('newPrimary');
    const setSecondaryDiv    = document.getElementById('setSecondaryDiv');
    const editSecondaryDiv   = document.getElementById('editSecondaryDiv');
    const newSecondaryEl     = document.getElementById('newSecondary');
    const currentSecondaryEl = document.getElementById('currentSecondary');
    const newSecondaryEditEl = document.getElementById('newSecondaryEdit');


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // localStorage UTILITIES
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveFolders() {
      localStorage.setItem('folders', JSON.stringify(folders));
    }
    function saveLinks() {
      localStorage.setItem('links', JSON.stringify(links));
    }
    function loadData() {
      folders = JSON.parse(localStorage.getItem('folders') || 'null');
      links   = JSON.parse(localStorage.getItem('links')   || 'null');

      if (!folders) {
        // Firstâ€time: create â€œGeneralâ€ and â€œHiddenâ€ folders
        const genId = Date.now().toString();
        const hidId = (Date.now() + 1).toString();
        folders = [
          { id: genId, name: DEFAULT_FOLDER_NAME, isHidden: false },
          { id: hidId, name: HIDDEN_FOLDER_NAME, isHidden: true }
        ];
        saveFolders();
      }
      if (!links) {
        links = [];
        saveLinks();
      }
    }

    // Generate a unique ID for items
    function genId() {
      return Date.now().toString() + Math.floor(Math.random() * 1000);
    }


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER FOLDER LIST IN SIDEBAR
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFolderList() {
      folderListEl.innerHTML = '';
      folders.forEach(folder => {
        const li = document.createElement('li');
        li.dataset.folderId = folder.id;

        // Text + lock emoji if hidden
        li.textContent = folder.name + (folder.isHidden ? ' ğŸ”’' : '');

        // If this is currently selected, highlight it
        if (folder.id === currentFolderId) {
          li.classList.add('selected');
        }

        // Click to select
        li.onclick = () => selectFolder(folder.id);

        // If folder is neither General nor Hidden, add a delete icon
        if (!folder.isHidden && folder.name !== DEFAULT_FOLDER_NAME) {
          const delSpan = document.createElement('span');
          delSpan.className = 'folder-delete-icon';
          delSpan.textContent = 'ğŸ—‘ï¸';
          delSpan.title = 'Delete folder';
          delSpan.onclick = e => {
            e.stopPropagation();
            deleteFolder(folder.id);
          };
          li.appendChild(delSpan);
        }

        folderListEl.appendChild(li);
      });
    }

    addFolderBtn.onclick = () => {
      const name = prompt('Enter new folder name:').trim();
      if (!name) return;
      // Cannot name a folder â€œHiddenâ€
      if (name.toLowerCase() === HIDDEN_FOLDER_NAME.toLowerCase()) {
        alert(`"${HIDDEN_FOLDER_NAME}" is reserved.`);
        return;
      }
      const newId = genId();
      folders.push({ id: newId, name, isHidden: false });
      saveFolders();
      renderFolderList();
    };

    function deleteFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;
      const confirmDel = confirm(`Delete folder "${folder.name}" and all its links? This cannot be undone.`);
      if (!confirmDel) return;
      // Remove the folder
      folders = folders.filter(f => f.id !== folderId);
      saveFolders();
      // Remove any links in that folder
      links = links.filter(l => l.folderId !== folderId);
      saveLinks();
      // If the deleted folder was open, switch to General
      if (currentFolderId === folderId) {
        const gen = folders.find(f => !f.isHidden);
        currentFolderId = gen.id;
      }
      renderFolderList();
      openFolder(currentFolderId);
    }


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SELECT & DISPLAY CURRENT FOLDER
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function selectFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;

      // If this is Hidden, handle twoâ€step password
      if (folder.isHidden) {
        const pwd1 = localStorage.getItem('hiddenPassword1');
        if (!pwd1) {
          // No primary yet â†’ set it
          showPasswordModal('setHiddenPrimary', folderId);
          return;
        }
        // Prompt for primary verification
        showPasswordModal('verifyHiddenPrimary', folderId);
        return;
      }

      // Non-hidden: simply open
      openFolder(folderId);
    }

    function openFolder(folderId) {
      currentFolderId = folderId;
      const folder = folders.find(f => f.id === folderId);

      folderTitleEl.textContent = folder.name + (folder.isHidden ? ' ğŸ”’' : '');
      // Show or hide â€œManage Passwordsâ€ button
      if (folder.isHidden) {
        managePasswordsBtn.classList.remove('hidden');
      } else {
        managePasswordsBtn.classList.add('hidden');
      }
      linkFormContainer.classList.remove('hidden');
      renderLinks();
      renderFolderList();
      buildColorFilterOptions();
    }


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PASSWORD MODAL (Twoâ€Step for Hidden Folder)
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showPasswordModal(mode, folderId = null) {
      passwordMode = mode; // 'setHiddenPrimary', 'verifyHiddenPrimary', 'verifyHiddenSecondary'
      pwdInput.value = '';
      pwdError.textContent = '';
      pendingMoveTargetFolderId = folderId; // which hidden folder to open

      if (mode === 'setHiddenPrimary') {
        document.getElementById('pwdModalTitle').textContent = 'Create Primary Password for Hidden';
      }
      else if (mode === 'verifyHiddenPrimary') {
        document.getElementById('pwdModalTitle').textContent = 'Enter Primary Password';
      }
      else if (mode === 'verifyHiddenSecondary') {
        document.getElementById('pwdModalTitle').textContent = 'Enter Secondary Password';
      }

      passwordModal.style.display = 'flex';
      pwdInput.focus();
    }

    function submitPassword() {
      const val = pwdInput.value.trim();

      // 1) Setting primary for first time
      if (passwordMode === 'setHiddenPrimary') {
        if (val.length < 3) {
          pwdError.textContent = 'Password must be at least 3 characters.';
          return;
        }
        localStorage.setItem('hiddenPassword1', val);
        passwordModal.style.display = 'none';
        openFolder(pendingMoveTargetFolderId || folders.find(f => f.isHidden).id);
        return;
      }

      // 2) Verifying primary
      if (passwordMode === 'verifyHiddenPrimary') {
        const stored1 = localStorage.getItem('hiddenPassword1');
        if (val === stored1) {
          // Check if secondary exists
          const stored2 = localStorage.getItem('hiddenPassword2');
          if (stored2) {
            // Prompt for secondary now
            passwordMode = 'verifyHiddenSecondary';
            pwdInput.value = '';
            pwdError.textContent = '';
            document.getElementById('pwdModalTitle').textContent = 'Enter Secondary Password';
            pwdInput.focus();
            return;
          }
          // No secondary: open directly
          passwordModal.style.display = 'none';
          openFolder(pendingMoveTargetFolderId || folders.find(f => f.isHidden).id);
        } else {
          pwdError.textContent = 'Incorrect primary password.';
        }
        return;
      }

      // 3) Verifying secondary
      if (passwordMode === 'verifyHiddenSecondary') {
        const stored2 = localStorage.getItem('hiddenPassword2');
        if (val === stored2) {
          passwordModal.style.display = 'none';
          openFolder(pendingMoveTargetFolderId || folders.find(f => f.isHidden).id);
        } else {
          pwdError.textContent = 'Incorrect secondary password.';
        }
        return;
      }
    }

    function cancelPassword() {
      passwordModal.style.display = 'none';
      pendingMoveTargetFolderId = null;
      passwordMode = '';
    }

    // Pressing Enter inside password input
    pwdInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitPassword();
      }
    });

    // Clicking outside or pressing Escape
    window.addEventListener('click', e => {
      if (e.target === passwordModal) cancelPassword();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && passwordModal.style.display === 'flex') {
        cancelPassword();
      }
    });


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ADDING NEW LINKS
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    linkForm.onsubmit = e => {
      e.preventDefault();
      if (!currentFolderId) return;
      const name = document.getElementById('linkName').value.trim();
      const url  = document.getElementById('linkURL').value.trim();
      const desc = document.getElementById('linkDesc').value.trim();
      if (!name || !url) return;

      const newLink = {
        id: genId(),
        folderId: currentFolderId,
        name,
        url,
        description: desc,
        color: '' // no color by default
      };
      links.push(newLink);
      saveLinks();
      linkForm.reset();
      renderLinks();
    };


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDERING & FILTERING LINKS
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildColorFilterOptions() {
      colorFilterEl.innerHTML = '<option value="">All</option>';
      COLOR_PALETTE.forEach(colorObj => {
        const opt = document.createElement('option');
        opt.value = colorObj.hex;
        opt.textContent = colorObj.name;
        opt.style.backgroundColor = colorObj.hex;
        opt.style.color = '#000';
        colorFilterEl.appendChild(opt);
      });
    }

    colorFilterEl.onchange = () => {
      renderLinks();
    };

    function renderLinks() {
      linkListEl.innerHTML = '';
      if (!currentFolderId) return;

      const chosenColor = colorFilterEl.value;
      const folderLinks = links
        .filter(l => l.folderId === currentFolderId)
        .filter(l => chosenColor === '' || l.color === chosenColor);

      folderLinks.forEach(l => {
        const item = document.createElement('div');
        item.className = 'link-item';
        item.style.backgroundColor = l.color || '#1b1b1b';

        // Link info
        const info = document.createElement('div');
        info.className = 'link-info';
        info.innerHTML = `
          <h3><a href="${l.url}" target="_blank">${l.name}</a></h3>
          <p>${l.description}</p>
        `;

        // Three-dots menu
        const menuIcon = document.createElement('span');
        menuIcon.className = 'menu-icon';
        menuIcon.textContent = 'â‹®';
        menuIcon.addEventListener('click', e => openContextMenu(e, l.id));

        item.appendChild(info);
        item.appendChild(menuIcon);
        linkListEl.appendChild(item);
      });
    }


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // CONTEXT MENU (â‹®) FOR LINKS
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openContextMenu(e, linkId) {
      e.preventDefault();
      e.stopPropagation();

      pendingMoveLinkId   = linkId;
      pendingColorLinkId  = linkId;
      pendingDeleteLinkId = linkId;

      const menuWidth = 180;
      let x = e.clientX - (menuWidth - 20);
      if (x < 5) x = 5;
      let y = e.clientY + 5;
      contextMenu.style.top  = y + 'px';
      contextMenu.style.left = x + 'px';
      contextMenu.style.display = 'block';
    }

    // Hide when clicking outside
    document.addEventListener('click', e => {
      if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
      }
    });

    // Move to Folderâ€¦
    ctxMove.onclick = () => {
      contextMenu.style.display = 'none';
      showMoveModal(pendingMoveLinkId);
    };

    // Set Color Tagâ€¦
    ctxColor.onclick = () => {
      contextMenu.style.display = 'none';
      showColorModal(pendingColorLinkId);
    };

    // Share by Email
    ctxShare.onclick = () => {
      contextMenu.style.display = 'none';
      const link = links.find(l => l.id === pendingMoveLinkId);
      if (link) {
        const subject = encodeURIComponent('Check out this link: ' + link.name);
        const body = encodeURIComponent(`I thought you might like this:\n\n${link.name}\n${link.url}\n\n${link.description}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      }
    };

    // Delete Link
    ctxDelete.onclick = () => {
      contextMenu.style.display = 'none';
      showDeleteModal(pendingDeleteLinkId);
    };


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // DELETE LINK MODAL LOGIC
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showDeleteModal(linkId) {
      pendingDeleteLinkId = linkId;
      deleteModal.style.display = 'flex';
    }

    function closeDeleteModal() {
      deleteModal.style.display = 'none';
      pendingDeleteLinkId = null;
    }

    function confirmDelete() {
      if (pendingDeleteLinkId) {
        links = links.filter(l => l.id !== pendingDeleteLinkId);
        saveLinks();
        renderLinks();
      }
      closeDeleteModal();
    }

    window.addEventListener('click', e => {
      if (e.target === deleteModal) closeDeleteModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
        closeDeleteModal();
      }
    });


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MOVE LINK MODAL
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showMoveModal(linkId) {
      pendingMoveLinkId = linkId;
      folderOptionsEl.innerHTML = '';
      folders.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.name + (f.isHidden ? ' ğŸ”’' : '');
        li.dataset.folderId = f.id;
        li.onclick = () => attemptMoveLink(f.id);
        folderOptionsEl.appendChild(li);
      });
      moveModal.style.display = 'flex';
    }

    function closeMoveModal() {
      moveModal.style.display = 'none';
      pendingMoveLinkId = null;
      pendingMoveTargetFolderId = null;
    }

    function attemptMoveLink(targetFolderId) {
      const target = folders.find(f => f.id === targetFolderId);
      if (!target) return;

      if (target.isHidden) {
        // Moving into Hidden â†’ require password
        const stored1 = localStorage.getItem('hiddenPassword1');
        if (!stored1) {
          closeMoveModal();
          showPasswordModal('setHiddenPrimary', targetFolderId);
          return;
        }
        closeMoveModal();
        passwordMode = 'verifyHiddenPrimary';
        pendingMoveTargetFolderId = targetFolderId;
        showPasswordModal('verifyHiddenPrimary', targetFolderId);
        return;
      }

      // Otherwise, move immediately
      moveLinkToFolder(pendingMoveLinkId, targetFolderId);
      closeMoveModal();
    }

    function moveLinkToFolder(linkId, destFolderId) {
      const idx = links.findIndex(l => l.id === linkId);
      if (idx === -1) return;
      links[idx].folderId = destFolderId;
      saveLinks();
      renderLinks();
    }

    window.addEventListener('click', e => {
      if (e.target === moveModal) closeMoveModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && moveModal.style.display === 'flex') {
        closeMoveModal();
      }
    });


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // COLOR PICKER MODAL
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showColorModal(linkId) {
      pendingColorLinkId = linkId;
      colorGrid.innerHTML = '';
      COLOR_PALETTE.forEach(colorObj => {
        const cell = document.createElement('div');
        cell.className = 'color-cell';
        cell.style.backgroundColor = colorObj.hex;
        cell.title = colorObj.name;
        cell.onclick = () => selectColorForLink(colorObj.hex);
        colorGrid.appendChild(cell);
      });
      colorModal.style.display = 'flex';
    }

    function closeColorModal() {
      colorModal.style.display = 'none';
      pendingColorLinkId = null;
    }

    function selectColorForLink(hex) {
      const idx = links.findIndex(l => l.id === pendingColorLinkId);
      if (idx === -1) return;
      links[idx].color = hex;
      saveLinks();
      renderLinks();
      closeColorModal();
    }

    window.addEventListener('click', e => {
      if (e.target === colorModal) closeColorModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && colorModal.style.display === 'flex') {
        closeColorModal();
      }
    });


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MANAGE PASSWORDS MODAL
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Open when â€œManage Passwordsâ€ is clicked
    managePasswordsBtn.onclick = () => openManageModal();

    function openManageModal() {
      // Show/hide appropriate sections depending on whether secondary exists
      const sec = localStorage.getItem('hiddenPassword2');
      if (sec) {
        setSecondaryDiv.classList.add('hidden');
        editSecondaryDiv.classList.remove('hidden');
      } else {
        setSecondaryDiv.classList.remove('hidden');
        editSecondaryDiv.classList.add('hidden');
      }
      // Clear inputs
      currentPrimaryEl.value = '';
      newPrimaryEl.value     = '';
      newSecondaryEl.value   = '';
      currentSecondaryEl.value = '';
      newSecondaryEditEl.value = '';
      manageModal.style.display = 'flex';
    }

    function cancelManage() {
      manageModal.style.display = 'none';
    }

    function handleChangePrimary() {
      const cur = currentPrimaryEl.value.trim();
      const nxt = newPrimaryEl.value.trim();
      const stored1 = localStorage.getItem('hiddenPassword1');
      if (!cur || !nxt) {
        alert('Please fill both fields.');
        return;
      }
      if (cur !== stored1) {
        alert('Current primary password is incorrect.');
        return;
      }
      if (nxt.length < 3) {
        alert('New primary must be at least 3 characters.');
        return;
      }
      localStorage.setItem('hiddenPassword1', nxt);
      alert('Primary password changed successfully.');
      cancelManage();
    }

    function handleSetSecondary() {
      const nxt = newSecondaryEl.value.trim();
      if (!nxt) {
        alert('Please enter a secondary password.');
        return;
      }
      localStorage.setItem('hiddenPassword2', nxt);
      alert('Secondary password set.');
      cancelManage();
    }

    function handleChangeSecondary() {
      const cur = currentSecondaryEl.value.trim();
      const nxt = newSecondaryEditEl.value.trim();
      const stored2 = localStorage.getItem('hiddenPassword2');
      if (!cur || !nxt) {
        alert('Please fill both fields.');
        return;
      }
      if (cur !== stored2) {
        alert('Current secondary password is incorrect.');
        return;
      }
      localStorage.setItem('hiddenPassword2', nxt);
      alert('Secondary password changed.');
      cancelManage();
    }

    function handleDeleteSecondary() {
      const confirmDel = confirm('Delete the secondary password?');
      if (!confirmDel) return;
      localStorage.removeItem('hiddenPassword2');
      alert('Secondary password deleted.');
      cancelManage();
    }

    window.addEventListener('click', e => {
      if (e.target === manageModal) cancelManage();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && manageModal.style.display === 'flex') {
        cancelManage();
      }
    });


    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // INITIAL SETUP & ENTRY POINT
    //â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function init() {
      loadData();
      const gen = folders.find(f => !f.isHidden);
      if (gen) currentFolderId = gen.id;
      renderFolderList();
      openFolder(currentFolderId);
    }

    init();
  </script>
</body>
</html>
