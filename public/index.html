<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Link Manager</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- =====================
       SIDEBAR (folders)
       ===================== -->
  <div class="sidebar">
    <h2>Folders</h2>
    <ul id="folderList"></ul>
    <button id="addFolderBtn">+ Add Folder</button>
  </div>

  <!-- =====================
       MAIN CONTENT AREA
       ===================== -->
  <div class="main">
    <h1 id="folderTitle">Loading...</h1>

    <!-- Form to add a new link (hidden when in Hidden folder until unlocked) -->
    <div id="linkFormContainer">
      <form id="linkForm">
        <input type="text" id="linkName" placeholder="Website Name" required>
        <input type="url" id="linkURL" placeholder="https://example.com" required>
        <textarea id="linkDesc" placeholder="Description" rows="2"></textarea>
        <button type="submit">Save Link</button>
      </form>
    </div>

    <!-- Filter by color -->
    <div id="filterContainer">
      <label for="colorFilter">Filter by Color:</label>
      <select id="colorFilter">
        <option value="">All</option>
      </select>
    </div>

    <!-- List of links -->
    <div id="linkList"></div>
  </div>

  <!-- ======================
       CONTEXT MENU (hidden by default)
       ====================== -->
  <div id="contextMenu" class="context-menu">
    <ul>
      <li id="ctxMove">Move to Folder…</li>
      <li id="ctxColor">Set Color Tag…</li>
      <li id="ctxShare">Share by Email</li>
      <li id="ctxDelete">Delete Link</li>
    </ul>
  </div>

  <!-- =========================
       MODAL: DELETE CONFIRMATION
       ========================= -->
  <div id="deleteModal">
    <div id="deleteModalContent">
      <h2>Are you sure you want to permanently delete this link?</h2>
      <div class="modal-buttons">
        <button onclick="closeDeleteModal()">Cancel</button>
        <button class="danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- ======================
       MODAL: PASSWORD PROMPT
       ====================== -->
  <div id="passwordModal">
    <div id="passwordModalContent">
      <h2 id="pwdModalTitle">Enter Password</h2>
      <input type="password" id="pwdInput" placeholder="Password">
      <p id="pwdError" style="color: red; margin-top: 6px;"></p>
      <div class="modal-buttons">
        <button onclick="cancelPassword()">Cancel</button>
        <button onclick="submitPassword()">OK</button>
      </div>
    </div>
  </div>

  <!-- =====================
       MODAL: MOVE LINK
       ===================== -->
  <div id="moveModal">
    <div id="moveModalContent">
      <h2>Select a Destination Folder</h2>
      <ul id="folderOptions"></ul>
      <div class="modal-buttons" style="margin-top: 15px;">
        <button onclick="closeMoveModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- =====================
       MODAL: COLOR PICKER
       ===================== -->
  <div id="colorModal">
    <div id="colorModalContent">
      <h2>Choose a Color Tag</h2>
      <div class="color-grid" id="colorGrid"></div>
      <div class="modal-buttons" style="margin-top: 15px;">
        <button onclick="closeColorModal()">Cancel</button>
      </div>
    </div>
  </div>


  <!-- =====================
       JavaScript Logic
       ===================== -->
  <script>
  (function() {
    // ───────────────────────────────────────────────────────────────────────────
    // 1) DATA STRUCTURES & INITIALIZATION
    //───────────────────────────────────────────────────────────────────────────
    // Each folder: { id: string, name: string, isHidden: boolean }
    // Each link:   { id: string, folderId: string, name: string,
    //               url: string, description: string, color: string }
    // localStorage keys: 'folders', 'links', 'hiddenPassword'

    const DEFAULT_FOLDER_NAME = 'General';
    const HIDDEN_FOLDER_NAME = 'Hidden';

    let folders = [];          // Array of folder objects
    let links = [];            // Array of link objects
    let currentFolderId = null;// ID of the folder currently open

    // Modal State
    let pendingDeleteLinkId = null;
    let pendingMoveLinkId = null;
    let pendingColorLinkId = null;
    let pendingMoveTargetFolderId = null;

    // Password Modal State
    let passwordMode = ''; // 'setHidden' or 'verifyHidden'

    // 12-color palette with names
    const COLOR_PALETTE = [
      { name: 'Red Light', hex: '#D71313' },
      { name: 'Crimson',   hex: '#BE3144' },
      { name: 'Hot Pink',  hex: '#FF55BB' },
      { name: 'Soft Pink', hex: '#EC7FA9' },
      { name: 'Platinum',  hex: '#7F55B1' },
      { name: 'Lilac',     hex: '#6F69AC' },
      { name: 'Midnight',  hex: '#2D336B' },
      { name: 'Electric',  hex: '#3A59D1' },
      { name: 'Forest',    hex: '#169976' },
      { name: 'Sage',      hex: '#6A9C89' },
      { name: 'Pumpkin',   hex: '#E78B48' },
      { name: 'Mustard',   hex: '#EFB036' },
    ];

    // Utilities for localStorage
    function saveFolders() {
      localStorage.setItem('folders', JSON.stringify(folders));
    }
    function saveLinks() {
      localStorage.setItem('links', JSON.stringify(links));
    }
    function loadData() {
      folders = JSON.parse(localStorage.getItem('folders') || 'null');
      links   = JSON.parse(localStorage.getItem('links')   || 'null');

      if (!folders) {
        // First-time setup: create “General” and “Hidden” folders
        const genId = Date.now().toString();
        const hidId = (Date.now()+1).toString();
        folders = [
          { id: genId, name: DEFAULT_FOLDER_NAME, isHidden: false },
          { id: hidId, name: HIDDEN_FOLDER_NAME,  isHidden: true  }
        ];
        saveFolders();
      }
      if (!links) {
        links = [];
        saveLinks();
      }
    }

    // Generate a unique ID string for new items
    function genId() {
      return Date.now().toString() + Math.floor(Math.random()*1000);
    }

    // ───────────────────────────────────────────────────────────────────────────
    // 2) RENDERING FOLDERS IN SIDEBAR
    //───────────────────────────────────────────────────────────────────────────
    const folderListEl = document.getElementById('folderList');
    const addFolderBtn = document.getElementById('addFolderBtn');

    function renderFolderList() {
      folderListEl.innerHTML = '';
      folders.forEach(folder => {
        const li = document.createElement('li');
        li.textContent = folder.name + (folder.isHidden ? ' 🔒' : '');
        li.dataset.folderId = folder.id;
        if (folder.id === currentFolderId) {
          li.classList.add('selected');
        }
        li.onclick = () => selectFolder(folder.id);
        folderListEl.appendChild(li);
      });
    }

    addFolderBtn.onclick = () => {
      const name = prompt('Enter new folder name:').trim();
      if (!name) return;
      // Do not allow “Hidden” (reserved)
      if (name.toLowerCase() === HIDDEN_FOLDER_NAME.toLowerCase()) {
        alert(`"${HIDDEN_FOLDER_NAME}" is reserved.`);
        return;
      }
      const newId = genId();
      folders.push({ id: newId, name, isHidden: false });
      saveFolders();
      renderFolderList();
    };

    // ───────────────────────────────────────────────────────────────────────────
    // 3) SELECT & DISPLAY CURRENT FOLDER
    //───────────────────────────────────────────────────────────────────────────
    const folderTitleEl     = document.getElementById('folderTitle');
    const linkFormContainer = document.getElementById('linkFormContainer');
    const linkForm          = document.getElementById('linkForm');
    const linkListEl        = document.getElementById('linkList');
    const colorFilterEl     = document.getElementById('colorFilter');

    function selectFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;
      // If “Hidden” folder and password not set/verified, show password modal
      if (folder.isHidden) {
        const storedPwd = localStorage.getItem('hiddenPassword');
        if (!storedPwd) {
          // Ask user to set a new password
          showPasswordModal('setHidden', folderId);
          return;
        }
        // Ask for verification
        showPasswordModal('verifyHidden', folderId);
        return;
      }
      // Non-hidden folder: simply open
      openFolder(folderId);
    }

    function openFolder(folderId) {
      currentFolderId = folderId;
      const folder = folders.find(f => f.id === folderId);

      folderTitleEl.textContent = folder.name + (folder.isHidden ? ' 🔒' : '');
      linkFormContainer.classList.remove('hidden');
      renderLinks();
      renderFolderList();
      buildColorFilterOptions();
    }

    // ───────────────────────────────────────────────────────────────────────────
    // 4) PASSWORD MODAL (Set / Verify) FOR HIDDEN FOLDER
    //───────────────────────────────────────────────────────────────────────────
    const passwordModal      = document.getElementById('passwordModal');
    const passwordModalTitle = document.getElementById('pwdModalTitle');
    const pwdInput           = document.getElementById('pwdInput');
    const pwdError           = document.getElementById('pwdError');

    function showPasswordModal(mode, folderId = null) {
      passwordMode = mode; // 'setHidden' or 'verifyHidden'
      pwdInput.value = '';
      pwdError.textContent = '';
      pendingMoveTargetFolderId = folderId; // store which hidden folder to open/move

      if (mode === 'setHidden') {
        passwordModalTitle.textContent = 'Create a password for Hidden folder';
      } else if (mode === 'verifyHidden') {
        passwordModalTitle.textContent = 'Enter password to open Hidden';
      }
      passwordModal.style.display = 'flex';
      pwdInput.focus();
    }

    function submitPassword() {
      const val = pwdInput.value.trim();
      if (passwordMode === 'setHidden') {
        if (val.length < 3) {
          pwdError.textContent = 'Password must be at least 3 chars.';
          return;
        }
        localStorage.setItem('hiddenPassword', val);
        passwordModal.style.display = 'none';
        openFolder(folders.find(f => f.isHidden).id);
      }
      else if (passwordMode === 'verifyHidden') {
        const stored = localStorage.getItem('hiddenPassword');
        if (val === stored) {
          passwordModal.style.display = 'none';
          openFolder(pendingMoveTargetFolderId || folders.find(f => f.isHidden).id);
          // If verifying for “move into Hidden,” actually perform that move now
          if (pendingMoveTargetFolderId && pendingMoveLinkId) {
            moveLinkToFolder(pendingMoveLinkId, pendingMoveTargetFolderId);
            pendingMoveTargetFolderId = null;
            pendingMoveLinkId = null;
          }
        } else {
          pwdError.textContent = 'Incorrect password.';
        }
      }
    }

    function cancelPassword() {
      passwordModal.style.display = 'none';
      pendingMoveTargetFolderId = null;
      passwordMode = '';
    }

    // Allow pressing Enter in the password input
    pwdInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitPassword();
      }
    });

    // Close password modal when clicking outside or pressing Escape
    window.addEventListener('click', e => {
      if (e.target === passwordModal) cancelPassword();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && passwordModal.style.display === 'flex') {
        cancelPassword();
      }
    });

    // ───────────────────────────────────────────────────────────────────────────
    // 5) ADDING NEW LINKS
    //───────────────────────────────────────────────────────────────────────────
    linkForm.onsubmit = e => {
      e.preventDefault();
      if (!currentFolderId) return;
      const name = document.getElementById('linkName').value.trim();
      const url  = document.getElementById('linkURL').value.trim();
      const desc = document.getElementById('linkDesc').value.trim();
      if (!name || !url) return;

      const newLink = {
        id: genId(),
        folderId: currentFolderId,
        name,
        url,
        description: desc,
        color: '' // no color by default
      };
      links.push(newLink);
      saveLinks();
      linkForm.reset();
      renderLinks();
    };

    // ───────────────────────────────────────────────────────────────────────────
    // 6) RENDERING & FILTERING LINKS IN THE CURRENT FOLDER
    //───────────────────────────────────────────────────────────────────────────
    function buildColorFilterOptions() {
      // Clear previous options except “All”
      colorFilterEl.innerHTML = '<option value="">All</option>';
      COLOR_PALETTE.forEach(colorObj => {
        const opt = document.createElement('option');
        opt.value = colorObj.hex;
        opt.textContent = colorObj.name;
        // Optionally: show swatch background
        opt.style.backgroundColor = colorObj.hex;
        opt.style.color = '#000';
        colorFilterEl.appendChild(opt);
      });
    }

    colorFilterEl.onchange = () => {
      renderLinks();
    };

    function renderLinks() {
      linkListEl.innerHTML = '';
      if (!currentFolderId) return;

      const chosenColor = colorFilterEl.value;
      const folderLinks = links
        .filter(l => l.folderId === currentFolderId)
        .filter(l => chosenColor === '' || l.color === chosenColor);

      folderLinks.forEach(l => {
        const item = document.createElement('div');
        item.className = 'link-item';
        // Set background to chosen color (or default dark if no color)
        item.style.backgroundColor = l.color || '#1b1b1b';

        // Link info (middle)
        const info = document.createElement('div');
        info.className = 'link-info';
        info.innerHTML = `
          <h3><a href="${l.url}" target="_blank">${l.name}</a></h3>
          <p>${l.description}</p>
        `;

        // Three-dots menu icon (right)
        const menuIcon = document.createElement('span');
        menuIcon.className = 'menu-icon';
        menuIcon.textContent = '⋮';
        menuIcon.addEventListener('click', e => openContextMenu(e, l.id));

        item.appendChild(info);
        item.appendChild(menuIcon);

        linkListEl.appendChild(item);
      });
    }

    // ───────────────────────────────────────────────────────────────────────────
    // 7) CONTEXT MENU (⋮) FOR EACH LINK
    //───────────────────────────────────────────────────────────────────────────
    const contextMenu = document.getElementById('contextMenu');
    const ctxMove     = document.getElementById('ctxMove');
    const ctxShare    = document.getElementById('ctxShare');
    const ctxColor    = document.getElementById('ctxColor');
    const ctxDelete   = document.getElementById('ctxDelete');

    function openContextMenu(e, linkId) {
      e.preventDefault();
      e.stopPropagation(); // Prevent it from closing immediately
      pendingMoveLinkId   = linkId;
      pendingColorLinkId  = linkId;
      pendingDeleteLinkId = linkId;

      // Position menu slightly to the left of cursor
      const menuWidth = 180; // matches the CSS width
      let x = e.clientX - (menuWidth - 20);
      if (x < 5) x = 5; // prevent going off-screen too far left
      let y = e.clientY + 5;
      contextMenu.style.top  = y + 'px';
      contextMenu.style.left = x + 'px';
      contextMenu.style.display = 'block';
    }

    // Hide context menu when clicking anywhere outside it
    document.addEventListener('click', e => {
      if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
        contextMenu.style.display = 'none';
      }
    });

    // MENU ACTION: Move to Folder…
    ctxMove.onclick = () => {
      contextMenu.style.display = 'none';
      showMoveModal(pendingMoveLinkId);
    };

    // MENU ACTION: Set Color Tag…
    ctxColor.onclick = () => {
      contextMenu.style.display = 'none';
      showColorModal(pendingColorLinkId);
    };

    // MENU ACTION: Share by Email
    ctxShare.onclick = () => {
      contextMenu.style.display = 'none';
      const link = links.find(l => l.id === pendingMoveLinkId);
      if (link) {
        const subject = encodeURIComponent('Check out this link: ' + link.name);
        const body = encodeURIComponent(`I thought you might like this:\n\n${link.name}\n${link.url}\n\n${link.description}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      }
    };

    // MENU ACTION: Delete Link
    ctxDelete.onclick = () => {
      contextMenu.style.display = 'none';
      showDeleteModal(pendingDeleteLinkId);
    };

    // ───────────────────────────────────────────────────────────────────────────
    // 8) DELETE MODAL LOGIC
    //───────────────────────────────────────────────────────────────────────────
    const deleteModal = document.getElementById('deleteModal');

    function showDeleteModal(linkId) {
      pendingDeleteLinkId = linkId;
      deleteModal.style.display = 'flex';
    }
    function closeDeleteModal() {
      deleteModal.style.display = 'none';
      pendingDeleteLinkId = null;
    }
    function confirmDelete() {
      if (pendingDeleteLinkId) {
        links = links.filter(l => l.id !== pendingDeleteLinkId);
        saveLinks();
        renderLinks();
      }
      closeDeleteModal();
    }
    // Close when clicking outside the modal content
    window.addEventListener('click', e => {
      if (e.target === deleteModal) {
        closeDeleteModal();
      }
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
        closeDeleteModal();
      }
    });

    // ───────────────────────────────────────────────────────────────────────────
    // 9) MOVE LINK MODAL
    //───────────────────────────────────────────────────────────────────────────
    const moveModal       = document.getElementById('moveModal');
    const folderOptionsEl = document.getElementById('folderOptions');

    function showMoveModal(linkId) {
      pendingMoveLinkId = linkId;
      // Populate folderOptions list
      folderOptionsEl.innerHTML = '';
      folders.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.name + (f.isHidden ? ' 🔒' : '');
        li.dataset.folderId = f.id;
        li.onclick = () => attemptMoveLink(f.id);
        folderOptionsEl.appendChild(li);
      });
      moveModal.style.display = 'flex';
    }

    function closeMoveModal() {
      moveModal.style.display = 'none';
      pendingMoveLinkId = null;
      pendingMoveTargetFolderId = null;
    }

    function attemptMoveLink(targetFolderId) {
      const target = folders.find(f => f.id === targetFolderId);
      if (!target) return;

      // If target is hidden, require password
      if (target.isHidden) {
        const storedPwd = localStorage.getItem('hiddenPassword');
        if (!storedPwd) {
          closeMoveModal();
          showPasswordModal('setHidden', targetFolderId);
          return;
        }
        // Prompt for password
        closeMoveModal();
        passwordMode = 'verifyHidden';
        pendingMoveTargetFolderId = targetFolderId;
        showPasswordModal('verifyHidden');
        return;
      }

      // Otherwise, just move immediately
      moveLinkToFolder(pendingMoveLinkId, targetFolderId);
      closeMoveModal();
    }

    function moveLinkToFolder(linkId, destFolderId) {
      const idx = links.findIndex(l => l.id === linkId);
      if (idx === -1) return;
      links[idx].folderId = destFolderId;
      saveLinks();
      renderLinks();
    }
    // Close move modal when clicking outside
    window.addEventListener('click', e => {
      if (e.target === moveModal) {
        closeMoveModal();
      }
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && moveModal.style.display === 'flex') {
        closeMoveModal();
      }
    });

    // ───────────────────────────────────────────────────────────────────────────
    // 10) COLOR PICKER MODAL
    //───────────────────────────────────────────────────────────────────────────
    const colorModal = document.getElementById('colorModal');
    const colorGrid  = document.getElementById('colorGrid');

    function showColorModal(linkId) {
      pendingColorLinkId = linkId;
      colorGrid.innerHTML = '';
      COLOR_PALETTE.forEach(colorObj => {
        const cell = document.createElement('div');
        cell.className = 'color-cell';
        cell.style.backgroundColor = colorObj.hex;
        cell.title = colorObj.name; // Hover text shows the name
        cell.onclick = () => selectColorForLink(colorObj.hex);
        colorGrid.appendChild(cell);
      });
      colorModal.style.display = 'flex';
    }

    function closeColorModal() {
      colorModal.style.display = 'none';
      pendingColorLinkId = null;
    }

    function selectColorForLink(hex) {
      const idx = links.findIndex(l => l.id === pendingColorLinkId);
      if (idx === -1) return;
      links[idx].color = hex;
      saveLinks();
      renderLinks();
      closeColorModal();
    }
    // Close color modal when clicking outside
    window.addEventListener('click', e => {
      if (e.target === colorModal) closeColorModal();
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && colorModal.style.display === 'flex') {
        closeColorModal();
      }
    });

    // ───────────────────────────────────────────────────────────────────────────
    // 11) INITIAL SETUP & ENTRY POINT
    //───────────────────────────────────────────────────────────────────────────
    function init() {
      loadData();
      // By default, open “General” folder
      const gen = folders.find(f => !f.isHidden);
      if (gen) currentFolderId = gen.id;
      renderFolderList();
      openFolder(currentFolderId);
    }

    init();
  })();
  </script>
</body>
</html>
